{% extends 'users/base.html' %}
{% load static %}

{% block body %}
<div class="text-center my-8">
    <h2 class="text-3xl font-bold text-gray-800 group">
        Your <span class="text-pink-500">Feed</span>
    </h2>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-10 p-5 md:p-10 max-w-7xl mx-auto">
    {% for post in posts %}
    <div class="rounded overflow-hidden bg-white shadow-md hover:shadow-lg transition duration-300">

        <!-- User Info -->
        <div class="flex items-center px-5 py-4">
            <img class="h-10 w-10 rounded-full" src="{{ post.user.profile.photo.url }}" alt="User Photo">
            <div class="ml-3 font-medium text-gray-800">{{ post.user.username }}</div>
        </div>

        <!-- Post Image -->
        <div class="aspect-[4/5] w-full">
            <img src="{{ post.image.url }}" alt="Post Image" class="w-full h-full object-cover rounded-t">
        </div>




        <!-- Icons -->
        <div class="flex gap-4 px-5 py-3 items-center">
            <button type="button" class="btn-like cursor-pointer" data-id="{{ post.id }}">
                <img class="w-5 h-5 like-icon" src="{% static 'users/images/like.png' %}" alt="Like">
            </button>
            <img class="w-5 h-5" src="{% static 'users/images/comment.png' %}" alt="Comment">
            <img class="w-5 h-5" src="{% static 'users/images/share.png' %}" alt="Share">
        </div>

        <!-- Like Count -->
        <div class="px-5 pb-2">
            <span class="text-sm text-gray-600">
                <span class="like-count" data-id="{{ post.id }}">{{ post.liked_by.count }}</span>
                like{{ post.liked_by.count|pluralize }}
            </span>
        </div>

        <!-- Post Title & Caption -->
        <div class="px-5 pb-5">
            <div class="font-semibold text-lg text-gray-800">{{ post.title }}</div>
            <p class="text-sm text-gray-600 mt-2">{{ post.caption }}</p>
        </div>
    </div>
    {% empty %}
    <p class="text-center text-gray-500 col-span-full">No posts yet from users you follow.</p>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

<!-- Like Animation CSS -->
<style>
    .liked {
        filter: brightness(1.3);
        transform: scale(1.3);
        transition: all 0.2s ease;
    }
</style>

<!-- AJAX Like Logic -->
<script>
    $(document).ready(function () {
        $('.btn-like').on('click', function () {
            const postId = $(this).data('id');
            const button = $(this);
            const icon = button.find('.like-icon');
            const countEl = $(`.like-count[data-id="${postId}"]`);

            $.ajax({
                url: "{% url 'like_post' %}",
                method: 'POST',
                data: {
                    post_id: postId,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.liked) {
                        icon.attr('src', "{% static 'users/images/liked.png' %}");
                        icon.addClass('liked');
                    } else {
                        icon.attr('src', "{% static 'users/images/like.png' %}");
                        icon.removeClass('liked');
                    }

                    countEl.text(response.likes_count);
                },
                error: function (xhr, status, error) {
                    console.error('‚ùå AJAX error:', error);
                }
            });
        });
    });
</script>
{% endblock %}
